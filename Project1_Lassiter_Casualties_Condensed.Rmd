---
title: "Project1"
author: "Daniel Lassiter, Tom Muhlbaur, and Rachael Stryker"
date: "10/23/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos="!h")
```


```{r importing libraries installing packages and loading data, echo = FALSE, warning = FALSE, message = FALSE, include=FALSE}
#Import libraries
library(tidyverse)
library(tibble)
library(dplyr)
library(ggplot2)
library(ggfortify)
library(lattice)
library(GGally)
library(MASS)
library(lindia)
library(ggpubr)
# install.packages("devtools")
library(devtools)
# install_github("vqv/ggbiplot")
library(ggbiplot)
library(data.table)
library(gplots)
library(boot)
source("http://www.phaget4.org/R/myImagePlot.R")
# install.packages('forecast', dependencies = TRUE)
library(forecast)

#Set directories:
sourcedir <- "C:/Users/Daniel/Dropbox/Self organization/Education/UVA/Graduate School/Coursework/Fall_2020/SYS 6021 Linear Statistical Models/Source"
traindir <- "C:/Users/Daniel/Dropbox/Self organization/Education/UVA/Graduate School/Coursework/Fall_2020/SYS 6021 Linear Statistical Models/Data/TrainData"


# Source AccidentInput
setwd(sourcedir)
source("AccidentInput.R")
source("SPM_Panel.R")
source("PCAplots.R")
source("TestSet.R")

# Data Procesing

## Create list of dataframes
acts <- file.inputl(traindir)


## Combine all data into a single dataframe

totacts <- combine.data(acts)

## Process data variables to be easier to work with
### TYPE
totacts$TYPE <- factor(totacts$TYPE, labels = c("Derailment", "HeadOn", "Rearend", "Side", "Raking", "BrokenTrain", "Hwy-Rail", "GradeX", "Obstruction", "Explosive", "Fire","Other","SeeNarrative" ))

### TYPEQ
totacts$TYPEQ <- factor(totacts$TYPEQ, labels = c("Freight", "Passenger", "Commuter", "Work",  "Single", "CutofCars", "Yard", "Light", "Maint", "Other", "Other", "Other", "Other", "Other", "Other"))

### WEATHER
totacts$WEATHER <- factor(totacts$WEATHER, labels = c("clear", "cloudy", "rain", "fog", "sleet", "snow"))

### VISIBLTY
totacts$VISIBLTY <- factor(totacts$VISIBLTY, labels = c("dawn", "day", "dusk", "dark"))

### Cause
totacts$Cause <- rep(NA, nrow(totacts))

totacts$Cause[which(substr(totacts$CAUSE, 1, 1) == "M")] <- "(M) Miscellaneous Causes Not Otherwise Listed"
totacts$Cause[which(substr(totacts$CAUSE, 1, 1) == "T")] <- "(T) Rack, Roadbed and Structures"
totacts$Cause[which(substr(totacts$CAUSE, 1, 1) == "S")] <- "(S) Signal and Communication"
totacts$Cause[which(substr(totacts$CAUSE, 1, 1) == "H")] <- "(H) Train operation - Human Factors"
totacts$Cause[which(substr(totacts$CAUSE, 1, 1) == "E")] <- "(E) Mechanical and Electrical Failures"

totacts$Cause <- factor(totacts$Cause)

### Multi Railroad
totacts$MultiRR <- rep(NA, nrow(totacts))
totacts$MultiRR[which(totacts$RR2 == "")] <- FALSE
totacts$MultiRR[which(totacts$RR2 != "")] <- TRUE

### Time of day

for (i in 1:length(totacts)){
  if (totacts$AMPM[i] == 'PM'){
    totacts$Time24hr[i] <- totacts$TIMEHR[i] + 12 + totacts$TIMEMIN[i]/60
  }
  else{
    totacts$Time24hr[i] <- totacts$TIMEHR[i] + totacts$TIMEMIN[i]/60
  }
}

## Remove duplicates
totacts_DR <- totacts[!(duplicated(totacts[, c("INCDTNO", "YEAR", "MONTH", "DAY", "TIMEHR", "TIMEMIN")])),]

## Create dataframe with only accidents with 1 or more casualty
totacts_DR$Casualty <- (totacts_DR$TOTINJ + totacts_DR$TOTKLD)
totacts_wCasualties_DR <- subset.data.frame(totacts_DR, totacts_DR$Casualty>0)
rownames(totacts_wCasualties_DR) <- NULL

```

# Exploratory Data Analysis
## Selecting qualitative predictors
We started our exploratory data analysis by inspecting casualty producing accidents by accident type.

```{r creating plots, include = FALSE, echo=FALSE}
# Exploration:
## Accident frequency by type
plt1 <- ggplot(as.data.frame(table(totacts_wCasualties_DR$TYPE)), 
        aes(x = Var1, y= Freq)) + geom_bar(stat="identity") + 
        xlab("Type") + ylab("Count")+ theme(axis.text.x =
        element_text(angle = 45))


plt2 <- ggplot(totacts_wCasualties_DR,aes(TYPE,Casualty)) + 
        geom_col(na.rm=TRUE) + xlab("Type") + ylab("Sum") + theme(axis.text.x =
        element_text(angle = 45))

plt3 <- ggplot(data = totacts_wCasualties_DR, aes(x = TYPE, y = Casualty)) +  
        geom_boxplot() + coord_flip() + scale_fill_grey(start = 0.5, end = 0.8) +
        theme(plot.title = element_text(hjust = 0.5)) + 
        ggtitle("Box Plots of Equipment Damage") +labs(x = "Accident
        Type", y = "Casualties")

```

```{r , echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Frequency of casualty-producing accidents by type"}
plt1
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Total number of casualties by accident type"}
plt2
```

The relatively sharp increase in the total number of causalities for derailments indicate that these accidents are more severe on average than other accident types. This could be due to outliers.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Box plot of casualties by accident type"}
plt3
```


```{r removing outliers, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Inspecting the extreme events
plt_box <- ggplot(totacts_wCasualties_DR, aes(y=Casualty)) + geom_boxplot()
upper <- ggplot_build(plt_box)$data[[1]]$ymax

### Inspecting outliers:
outlier <- totacts_wCasualties_DR[191, c('TOTKLD', 'TOTINJ', 'TYPE', 'Cause', 'STATION', 
                              "YEAR", "MONTH", "DAY")]

### Removing outliers:
totacts_wCasualties_DR_ER <- totacts_wCasualties_DR[-191,]
```
The boxplot reveals the largest outlier occurs in the derailments category. We decided to inspect this outlier and found that the accident took place in in Minot, North Dakota on January 18, 2002. According to a report released by the National Transportation Safety Board, the derailment happened after joint bars fractured. Five of the derailed cars which were carrying anhydrous ammonium ruptured which caused the vast majority of injuries to nearby residents. The Safety Board determined the cause of the accident to be insufficient track inspection and maintenance procedures. Crews only performed visual inspections which fail to detect small fatigue cracks (National Transportation Safety Board, 2004).

We removed this accident from the analysis because we thought the magnitude would skew all of our results. This report encouraged us to look for patterns in the accident cause variable.

```{r creating 3 dimensional bar plots, include=FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Inspecting for potential relationships between categorical variables
totacts_wCasualties_DR_ER$Cas_factor <- 
      rep(NA, nrow(totacts_wCasualties_DR_ER))
totacts_wCasualties_DR_ER$Cas_factor[which(totacts_wCasualties_DR_ER$Casualty
      <= 3)] <- "Less than or equal to 3 Casualties"
totacts_wCasualties_DR_ER$Cas_factor[which(totacts_wCasualties_DR_ER$Casualty
      > 3)] <- "Greater  to 3 Casualties (Above upper whisker)"
totacts_wCasualties_DR_ER$Cas_factor <- 
      factor(totacts_wCasualties_DR_ER$Cas_factor)

### (SUM) What other conditions are present for each casualty?
plt_1 <- ggplot(totacts_wCasualties_DR_ER,aes(TYPE,fill=Cause)) + 
      geom_bar(na.rm=TRUE)+ ylab("Count") + theme(axis.text.x =
        element_text(angle = 90))
plt_2 <- ggplot(totacts_wCasualties_DR_ER,aes(TYPE,Casualty,fill=Cause)) + 
      geom_col(na.rm=TRUE) + ylab("Sum") + theme(axis.text.x =
        element_text(angle = 90))
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Frequency of casualty-producing accidents by type and cause"}
plt_1
```
Since the cause of almost all type highway-rail accidents are miscellaneous which are a less descriptive category, we assumed that it would be more difficult to generate an actionable recommendation on this accident type. After the miscellaneous accident cause, we can see from this graph that the causes (H) Train operation - Human Factors and (T) Track, Roadbed, and Structures are the top 2 and 3 causes, respectively. The following analyses will focus on cause (T) accidents because because cause (H) accidents were inspected in another portion of this report. Next we looked for interactions between derailments and cause (T) accidents with each other and with other qualitative variables such as weather, visibility, and train type, but only the interaction plot between derailments and cause (T) is shown because there either weren't notable interactions with other variables or the variable didn't increase average test set PMSE when included in the model. 


```{r interaction plots with qualitative variables, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Interaction plots
  #### Create Day/Not Day as a variable
day <- rep(0, nrow(totacts_wCasualties_DR_ER))
day[which(totacts_wCasualties_DR_ER$VISIBLTY =='day')] <- 1
day <- as.factor(day)

  #### Clear/not clear as variable
clear <- rep(0, nrow(totacts_wCasualties_DR_ER))
clear[which(totacts_wCasualties_DR_ER$WEATHER =='clear')] <- 1
clear <- as.factor(clear)

  #### Create derailment variable
Derail <- rep(0, nrow(totacts_wCasualties_DR_ER))
Derail[which(totacts_wCasualties_DR_ER$TYPE == 'Derailment')] <- 1 
Derail <- as.factor(Derail)

  #### Cause - Train roadbed and structures
Cause_T <- rep(0, nrow(totacts_wCasualties_DR_ER))
Cause_T[which(totacts_wCasualties_DR_ER$Cause ==
      '(T) Rack, Roadbed and Structures')] <- 1
Cause_T <- as.factor(Cause_T)

  #### Cause - Train roadbed and structures
Cause_T <- rep(0, nrow(totacts_wCasualties_DR_ER))
Cause_T[which(totacts_wCasualties_DR_ER$Cause ==
      '(T) Rack, Roadbed and Structures')] <- 1
Cause_T <- as.factor(Cause_T)


### Plot
#### Derailment Plots
  # Interaction of Derailment and day
interaction.plot(Derail, day, totacts_wCasualties_DR_ER$Casualty)

  # Interaction of Derailment and clear
interaction.plot(Derail, clear, totacts_wCasualties_DR_ER$Casualty)

  # Interaction of Derailment and Cause - Track, Roadbed, and Structures
interaction.plot(Derail, Cause_T, totacts_wCasualties_DR_ER$Casualty)
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Interaction plot between derailments and cause (T)"}
interaction.plot(Derail, Cause_T, totacts_wCasualties_DR_ER$Casualty)
```
This plot shows that derailments are more severe when the cause is (T) which led us to include the interaction term in the model.


## Selecting quantitative variables
After working through this exploratory data analysis once and learning in the linear modeling phase that the box-cox transformed data performed better, we decided to re-do the exploratory data analysis of quantitative relationships using the box-cox transformed casualty data set.
```{r transforming data, include = FALSE, echo= FALSE}
# Creating a transformed response variable
## During linear modeling, the best transformation was -1.4 for each of model.
L <- -1.4

totacts_wCasualties_DR_ER$Cas_Trans <- 
          (totacts_wCasualties_DR_ER$Casualty^L-1)/L

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Scatter plot matrix of transformed casualties and potential quantitative predictors"}
uva.pairs(totacts_wCasualties_DR_ER[, c("Cas_Trans", "TRNSPD", "TEMP", "TONS",
      "Time24hr", "CARS")])
```
None of the variables had very high correlation with the transformed casualties dataset but train speed had the highest which is partially what led us to include that as a variable in our model. Next we performed principal components analysis to determine whether there were some hidden relationships.

```{r principal componenents analysis, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Doing PCA to look for hidden quantitative relationships:
totacts_wCasualties.pca <- princomp(totacts_wCasualties_DR_ER[,c("Cas_Trans",
      "TRNSPD", "CARS", "Time24hr", "TEMP", "TONS", "MONTH")], cor = T)


```


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Principal 1 and 3 loadings plots and the cumulative variance plot"}
barplot(totacts_wCasualties.pca$loadings[,1], main='PC1 Loadings', las = 2)

barplot(totacts_wCasualties.pca$loadings[,3], main='PC3 Loadings', las = 2)

cumplot(totacts_wCasualties.pca, col = "blue")
```
The transformed casualties data move with or opposite the train speed, hazardous cars, and tons variables in the first and 3rd principal components. Therefore these could also be potential predictors of casualties. However, each principal component explains a relatively low portion of the variance which indicates that the data are relatively uncorrelated so these relationships are likely not very strong. We did not include tons in our model because it did not improve the test set PMSE. Next we looked at interactions between these quantitative variables and our qualitative variables.

```{r interaction plots with quantiative variables, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Interaction plots
### Quantitative Variables

  #### Create TRNSPD variable
TrnSpd_box <- ggplot(totacts_wCasualties_DR_ER, aes(y=TRNSPD)) + geom_boxplot()

med <- ggplot_build(TrnSpd_box)$data[[1]]$middle

TRNSPD.factor <- totacts_wCasualties_DR_ER$TRNSPD
TRNSPD.factor[which(totacts_wCasualties_DR_ER$TRNSPD<med)]<-'below median train speed'
TRNSPD.factor[which(totacts_wCasualties_DR_ER$TRNSPD>=med)]<-'above median train speed'
TRNSPD.factor <- factor(TRNSPD.factor)

  #### Create CARS variable
CARS.factor <- totacts_wCasualties_DR_ER$CARS
CARS.factor[which(totacts_wCasualties_DR_ER$CARS == 0)]<-'No Hazard Cars'
CARS.factor[which(totacts_wCasualties_DR_ER$CARS > 0)]<-'1 or More Hazard Cars'
CARS.factor <- factor(CARS.factor)


```


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Interaction plots of train speed and hazerdous cars with type derailment and cause (T) accidents"}
### Plot
 
#### Derailment Plots

  # Interaction of Derailment and TRNSPD.factor
interaction.plot(Derail, TRNSPD.factor, totacts_wCasualties_DR_ER$Casualty)

  # Interaction of Derailment and CARS.factor
interaction.plot(Derail, CARS.factor, totacts_wCasualties_DR_ER$Casualty)

#### Cause (T) Plots

  # Interaction of Cause (T) and TRNSPD.factor
interaction.plot(Cause_T, TRNSPD.factor, totacts_wCasualties_DR_ER$Casualty)

  # Interaction of Cause (T) and CARS.factor
interaction.plot(Cause_T, CARS.factor, totacts_wCasualties_DR_ER$Casualty)

```

According to the previous four plots, both type derailment and cause (T) accidents interact with train speed and the presence of hazerdous cars to increase accident damage. 

# Hypothesis 1 formation:
$H_0:$ There is no relationship or an inverse relationship between accident casualties and cause (T) accidents as speed increases and as the number of hazmat carrying cars increases.

$H_1:$ There is a positive relationship relationship between accident casualties and cause (T) accidents as speed increases and as the number of hazmat carrying cars increases.


# Linear Modeling

We built three models of increasing complexity and selected the best model primarily using a comparison of average test set PMSE. The best model turned out to be a stepwise model built from the full second order model of the box-cox transformed response variable modeled as a function of the binary type derailment/not derailment variable, the cause (T)/not cause (T) variable, train speed, and number of hazardous cars. We tried adding other variables such as tons, car type passenger or commuter/not passenger or commuter, temperature, and 24 hour time but none of these variables significantly decreased PMSE in the resulting step wise model. Some of the variables, such as weather and visibility, were simply dropped during stepwise model creation. PMSE improvement significance in this case was a subjective judgment because we did not perform any statistical tests to compare the test set PMSE. Of the two other models we compared, one was built from just the derailment variable and cause (T) variable and one built from those two variables plus train speed and hazardous cars. Model performance in this case increased in complexity in terms of adjusted R-squared, AIC, BIC, and most importantly, test set PMSE. A graph showing the most important metric, PMSE, for each of the 100 test sets for each model is shown below followed by the summary of the best performing linear model.

```{r building a simple linear model, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Creating linear model with only qualitative variables
## Adding variables:
totacts_wCasualties_DR_ER$Derail <- Derail
totacts_wCasualties_DR_ER$Cause_Trck <- Cause_T

cas.lm1 <- lm(Casualty~(Derail + Cause_Trck), data = totacts_wCasualties_DR_ER)

## Would transforming the response variable make the residuals more Gaussian?

plt_BC1 <- gg_boxcox(cas.lm1)
### Yes.

## Build model with transformed response variable.
L1 <- boxcox(cas.lm1, plotit = F)$x[which.max(boxcox(cas.lm1, plotit = F)$y)]
cas.lm1_T <- lm((Casualty^L1 - 1) / L1~(Derail + Cause_Trck), data = totacts_wCasualties_DR_ER)

summary(cas.lm1_T)

plt_diag_lm1_T_RF <- autoplot(cas.lm1_T, which=1)
plt_diag_lm1_T_QQ <- autoplot(cas.lm1_T, which=2)
plt_diag_lm1_T_CL <- autoplot(cas.lm1_T, which=6)


# This simple linear model indicates that accident cause (T) has a significant positive relationship with accident damage. Derailment was not significant compared to other accident types. However, because of evidence from interaction plots, we will continue including this variable in the model in case it becomes significant once other variables are controlled for. The residuals vs. fitted and QQ plot indicate that the gaussian errors assumption is not being met. This is a recurring theme in the diagnostic plots.
```


```{r building a slightly more complicated model, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Build a main effects model with the addition of quantitative variables.
cas.lm2 <- lm(Casualty~Derail + Cause_Trck + CARS + TRNSPD,
      data = totacts_wCasualties_DR_ER)

## Would transforming the response variable make the residuals more Gaussian?

plt_BC2 <- gg_boxcox(cas.lm2)
### Yes.

## Does this require the same transformation as the previous model?
L2 <- boxcox(cas.lm2, plotit = F)$x[which.max(boxcox(cas.lm2, plotit = F)$y)]
L1
## Yes.

cas.lm2_T <- lm((Casualty^L1 - 1)/L1~Derail + Cause_Trck + CARS + TRNSPD,
      data = totacts_wCasualties_DR_ER)

summary(cas.lm2_T)

plt_diag_lm2_T_RF <- autoplot(cas.lm2_T, which=1)
plt_diag_lm2_T_QQ <- autoplot(cas.lm2_T, which=2)
plt_diag_lm2_T_CL <- autoplot(cas.lm2_T, which=6)

# When including these quantitative variables in the model, derailment becomes significant. CARS is insignificant.
```


```{r building step wise model, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
#Build a full second order model, perform step-wise regression, and perform diagnostics.
cas.lm3 <- lm(Casualty~(Derail + Cause_Trck + CARS + TRNSPD)^2 + 
      TRNSPD^2 + CARS^2, data = totacts_wCasualties_DR_ER)

## Would transforming the response variable make the residuals more Gaussian?

plt_BC3 <- gg_boxcox(cas.lm3)
### Yes.

## Does this require the same transformation as the first model?
L3 <- boxcox(cas.lm3, plotit = F)$x[which.max(boxcox(cas.lm3, plotit = F)$y)]
L1
## Yes.

cas.lm3_T <- lm((Casualty^L1-1)/L1~(Derail + Cause_Trck + CARS + TRNSPD)^2 + 
      TRNSPD^2 + CARS^2, data = totacts_wCasualties_DR_ER)


cas.lm3_T.step <- step(cas.lm3_T, trace = -1)
## Verify that the step-wise model is better using partial F-test
anova(cas.lm3_T,cas.lm3_T.step)

## AIC:
AIC(cas.lm3_T)
  
AIC(cas.lm3_T.step)

##BIC:
AIC(cas.lm3_T,k=log(nrow(totacts_wCasualties_DR_ER)))

AIC(cas.lm3_T.step,k=log(nrow(totacts_wCasualties_DR_ER)))

# By the partial F-test, AIC, and BIC, the step-wise model is superior.
```



```{r evaluating stepwise model, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Diangose the stepwise model
summary(cas.lm3_T.step)

plt_diag_lm3_T_RF <- autoplot(cas.lm3_T.step, which=1)
plt_diag_lm3_T_QQ <- autoplot(cas.lm3_T.step, which=2)
plt_diag_lm3_T_CL <- autoplot(cas.lm3_T.step, which=6)

#In the stepwise model, all the variables but the CARS main effects variable are significant. The diagnostic plots, however, indicate lack of fit in the non-gaussian distribution of the residuals and non-constant variance.
```



```{r comparing AIC and BIC of the 3 models, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
#selecting the best model

# Compare models using AIC and BIC:
## AIC:
AIC(cas.lm1_T)
AIC(cas.lm2_T)
AIC(cas.lm3_T.step)

## BIC:
AIC(cas.lm1_T,k=log(nrow(totacts_wCasualties_DR_ER)))
AIC(cas.lm2_T,k=log(nrow(totacts_wCasualties_DR_ER)))
AIC(cas.lm3_T.step,k=log(nrow(totacts_wCasualties_DR_ER)))

# The stepwise model performs best in terms of AIC and BIC.
```



```{r test sets, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
## Test sets
pmse.lm1.result<-NULL;
pmse.lm2.result<-NULL;
pmse.lm3.step.result<-NULL;

for (i in c(1:100)){
  #set test sets size: 
  test.size<-1/3
  # generate training sets and test sets from original data:
  cas.data1<-test.set(totacts_wCasualties_DR_ER,test.size)

  # Build model:
  lm1.train<-lm(Cas_Trans ~ Derail + Cause_Trck, data=cas.data1$train)
  lm2.train<-lm(Cas_Trans ~ Derail + Cause_Trck + CARS + 
      TRNSPD, data=cas.data1$train)
  lm3.train<-lm(Cas_Trans ~ Derail + Cause_Trck + CARS + 
    TRNSPD + Derail:CARS + Derail:TRNSPD + Cause_Trck:TRNSPD, 
      data=cas.data1$train)
  
  # Predict
  lm1.pred<-predict(lm1.train,newdata=cas.data1$test) 
  lm2.pred<-predict(lm2.train,newdata=cas.data1$test)
  lm3.pred<-predict(lm3.train,newdata=cas.data1$test)
  
  # compute PMSE:
  pmse.lm1<-mse(lm1.pred,cas.data1$test$Cas_Trans)
  pmse.lm2<-mse(lm2.pred,cas.data1$test$Cas_Trans)
  pmse.lm3<-mse(lm3.pred,cas.data1$test$Cas_Trans)
  
  # Add the PMSE for this run into your vector to store PMSE
  pmse.lm1.result<-c(pmse.lm1.result,pmse.lm1)
  pmse.lm2.result<-c(pmse.lm2.result,pmse.lm2)
  pmse.lm3.step.result<-c(pmse.lm3.step.result,pmse.lm3)
}

### Plot results method 2 with ggplot
Index <- 1:length(pmse.lm1.result);
df <- data.frame(Index,pmse.lm1.result,pmse.lm2.result, pmse.lm3.step.result)
plt_PMSE <- ggplot(data=df, aes(x=Index)) + geom_line(aes(y = pmse.lm1.result), 
      color = 'blue', size = 1) + geom_line(aes(y = pmse.lm2.result), 
      color = 'red', linetype = 'twodash', size = 1) + 
      geom_line(aes(y = pmse.lm3.step.result), color = 'green',size = 1) + 
      ggtitle("Model Comparison Based on PMSE") + 
      theme(plot.title = element_text(hjust = 0.5), 
      plot.caption =element_text(hjust = 0.5)) + 
      scale_color_discrete(name = "Models", 
            labels = c("Model 1", "Model 2", "Model 3"))


lm1_PMSE <- mean(pmse.lm1.result)
lm2_PMSE <- mean(pmse.lm2.result)
lm3_PMSE <- mean(pmse.lm3.step.result)
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="PMSE for each test set for each model. The blue line represents the model with the binary parameters derailment and cause (T). The dashed red line represents the model built from those two variables plus train speed and hazerdous cars. The green line represents the stepwise model whose parameters can be seen in the summary below. It clearly performed best."}
plt_PMSE

summary(cas.lm3_T.step)
```


Lastly, we diagnose our best fit linear model.
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.cap="Diagnostic plots for the best performing linear model."}
plt_diag_lm3_T_RF
plt_diag_lm3_T_QQ
plt_diag_lm3_T_CL
```

From inspecting the diagnostic plots, we can see that the assumption of independent and identically gaussian distributed is not met. This is not surprising considering countable datasets are often better suited for logistic regression rather than linear modeling. The QQ plot of the residuals also shows that the gaussian assumption is not met, even despite the transformation of the response. Lastly, the leverage vs. cook's distance plot shows that there are no high leverage outliers that prompted further inspection or removal.

# Conslusions
We fail to reject the hypothesis that there is no relationship or an inverse relationship between accident casualties and cause (T) accidents as speed increases and as the number of hazmat carrying cars increases. However, our model does reveal that the following increase accident severity: cause (T), train speed, an interactions between derailments and number of hazardous cars, and an interaction between derailment and train speed. Some tentative recommendations we could make from our modeling efforts include: decreasing speed limits, improving speed limit enforcement practices, and improving track inspection procedures. Future work could include: logistic regression to identify controllable variables for reducing the likelihood of derailments, and performing logistic regression to identify controllable variables that lead to higher casualty probabilities.



# Works Cited
National Transportation Safety Board. (2004). Derailment of Canadian Pacific Railway Freight Train 292-16 and Subsequent Release of Anhydrous Ammonia Near Minot, North Dakota January 18, 2002 (No. PB2004-916301; p. 92). National Transportation Safety Board.
















